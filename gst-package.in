#! /bin/sh

#######################################################################
#
#   Smalltalk package installer
#
#
#######################################################################


#######################################################################
#
# Copyright 1999, 2000, 2001, 2002, 2006, 2007 Free Software Foundation, Inc.
# Written by Paolo Bonzini.
#
# This file is part of GNU Smalltalk.
#
# GNU Smalltalk is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the Free
# Software Foundation; either version 2, or (at your option) any later version.
# 
# GNU Smalltalk is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
# FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more
# details.
# 
# You should have received a copy of the GNU General Public License along with
# GNU Smalltalk; see the file COPYING.  If not, write to the Free Software
# Foundation, 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.  
#
########################################################################

OPTIONS='-h|--help --version --load --no-load --no-install --uninstall --dist
	-t|--target-directory: --list-files: --list-packages
	--srcdir: --distdir|--destdir: --copy --all-files --vpath
	-n|--dry-run -I|--image-file:'

prefix=@prefix@
exec_prefix=@exec_prefix@
: ${GST=@bindir@/gst}

# The same shell functions used in gst-load and gst-sunit.

gst () {
  script=$1
  shift
  if test x${image_file:+set} = xset; then
    eval \"\$GST\" "$GSTARGS" -I \"\$image_file\" -qK \"\$script\" -a \"\$@\"
  else
    eval \"\$GST\" "$GSTARGS" -qK \"\$script\" -a \"\$@\"
  fi
} 

show_help () {
  eval \"\$GST\" "$GSTARGS" -qK scripts/Package.st -a \$1
  exit $?
}

getopt () {
  eval \"\$GST\" "$GSTARGS" -qK scripts/Getopt.st -a \"\$OPTIONS\" \"\$@\"
}

getopt "$@" | {
  load_dry_run=-n
  load_test=
  run_cmd=eval
  files=
  srcdir=
  while read opt arg; do
    case $opt in
      ERROR) show_help --bad ;;
      --help) show_help --help ;;
      --load) load_dry_run= ;;
      --test) load_test=--test ;;
      --dry-run) run_cmd=: ;;
      --list-files) run_cmd=: ;;
      --list-packages) run_cmd=: ;;
      --srcdir) srcdir=$arg ;;
      --image-file)
	test x${image_file:+set} = xset && show_help --bad
	image_file=$arg ;;
      --) files="$files '$arg'" ;;
    esac
  done

  set -e

  INSTALL='@INSTALL@' LN_S='@LN_S@' XZIP='@ZIP@' gst scripts/Package.st "$@"

  if test "$run_cmd" = eval && test "$load_test,$load_dry_run" != ,-n; then
    packages=`eval gst scripts/Package.st \
		${srcdir:+"--srcdir=$srcdir"}
		--list-packages "$files" `
    gst scripts/Load.st $load_dry_run $load_test $packages
  fi
}
